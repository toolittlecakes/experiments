<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibecoding</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --sidebar-bg: #1a1a1a;
      --main-bg: #f0f0f0;
      --text-color: #e0e0e0;
      --input-bg: #2a2a2a;
      --border-color: #333;
      --accent-color: #007bff;
      --user-msg-bg: #2c3e50;
      --assistant-msg-bg: #252525;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background-color: var(--sidebar-bg);
    }

    #app-container {
      display: flex;
      height: 100%;
    }

    #sidebar {
      width: 350px;
      min-width: 300px;
      background-color: var(--sidebar-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      box-sizing: border-box;
      border-right: 1px solid var(--border-color);
    }

    #sidebar h1 {
      margin: 0 0 1rem 0;
      text-align: center;
      font-size: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1rem;
    }

    .api-key-container,
    .model-selector-container {
      margin-bottom: 1rem;
    }

    .spec-container {
      margin-bottom: 1rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .api-key-container label,
    .model-selector-container label,
    .spec-container label {
      font-size: 0.8rem;
      color: #aaa;
      margin-bottom: 0.25rem;
      display: block;
    }

    #apiKeyInput,
    #modelSelect,
    #appSpec {
      width: 100%;
      padding: 0.5rem;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 4px;
      box-sizing: border-box;
    }

    #appSpec {
      resize: none;
      flex-grow: 1;
      min-height: 200px;
      font-family: inherit;
    }

    .reset-button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .reset-button:hover {
      background-color: #c82333;
    }

    .reset-button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .status-indicator {
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .status-indicator.waiting {
      background-color: #2a2a2a;
      color: #888;
    }

    .status-indicator.generating {
      background-color: #1a5490;
      color: #87ceeb;
    }

    .status-indicator.success {
      background-color: #1a4d1a;
      color: #90ee90;
    }

    .status-indicator.error {
      background-color: #4d1a1a;
      color: #ff6b6b;
    }

    #modelSelect {
      cursor: pointer;
    }

    #modelSelect option {
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    /* Simple scrollbar styling */
    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #chat-messages::-webkit-scrollbar-track {
      background: var(--input-bg);
    }

    #chat-messages::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 3px;
    }

    .message {
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user {
      background-color: var(--user-msg-bg);
      margin-left: 20px;
    }

    .message.assistant {
      background-color: var(--assistant-msg-bg);
    }

    .message.system {
      background-color: #3d3d3d;
      font-style: italic;
      font-size: 0.9em;
      color: #ccc;
    }

    .message strong {
      display: block;
      margin-bottom: 5px;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #999;
    }

    #chat-form {
      display: flex;
      margin-top: 1rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }

    #chat-input {
      flex-grow: 1;
      padding: 0.75rem;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 4px 0 0 4px;
      resize: none;
      font-family: inherit;
    }

    #chat-form button {
      padding: 0.75rem 1rem;
      background-color: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 0 4px 4px 0;
    }

    #chat-form button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    #main-content {
      flex-grow: 1;
      background-color: var(--main-bg);
    }

    #app-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Styling for code blocks inside messages */
    .message pre {
      background-color: #111;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message code {
      font-family: "Courier New", Courier, monospace;
      font-size: 0.9em;
    }
  </style>
</head>

<body>

  <div id="app-container">
    <div id="sidebar">
      <h1>Vibecoding</h1>
      <div class="api-key-container">
        <label for="apiKeyInput">OpenRouter API Key</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your key here">
      </div>
      <div class="model-selector-container">
        <label for="modelSelect">Model</label>
        <select id="modelSelect">
          <option value="openai/gpt-oss-120b">OpenAI GPT OSS 120B</option>
          <option value="qwen/qwen3-235b-a22b-2507">Qwen 3 235B</option>
          <option value="qwen/qwen3-coder">Qwen 3 Coder</option>
          <option value="meta-llama/llama-4-maverick">Llama 4 Maverick</option>
          <option value="meta-llama/llama-4-scout">Llama 4 Scout</option>
          <option value="meta-llama/llama-3.1-8b-instruct">Llama 3.1 8B</option>
        </select>
      </div>
      <div class="spec-container">
        <label for="appSpec">App Specification</label>
        <textarea id="appSpec" placeholder="Describe your application here..."></textarea>
        <button id="resetButton" class="reset-button">Reset</button>
        <div id="generation-status" class="status-indicator"></div>
      </div>
    </div>
    <div id="main-content">
      <iframe id="app-iframe" title="Live Application Preview"></iframe>
    </div>
  </div>

  <script>
    // --- DOM Elements ---
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const appSpec = document.getElementById('appSpec');
    const resetButton = document.getElementById('resetButton');
    const generationStatus = document.getElementById('generation-status');
    const appIframe = document.getElementById('app-iframe');

    // --- State Management ---
    let apiKey = localStorage.getItem('vibecoding_apiKey') || '';
    let selectedModel = localStorage.getItem('vibecoding_selectedModel') || 'openai/gpt-oss-120b';
    let currentSpec = localStorage.getItem('vibecoding_currentSpec') || '';
    let currentAppCode = localStorage.getItem('vibecoding_currentAppCode') || '';
    let isGenerating = false;
    let debounceTimer = null;
    let abortController = null;

    // --- Initial Application Code ---
    const initialAppCode = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibecoding App</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-screen">
    <div class="text-center p-4">
        <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Welcome to your App!</h1>
        <p class="mt-2 text-lg text-gray-600 dark:text-gray-300">Describe what you want to build in the specification area on the left.</p>
    </div>
</body>
</html>`;

    // --- Core Functions ---

    /**
     * Updates the iframe with the provided HTML code.
     * @param {string} code The HTML code to render.
     */
    function updateIframe(code) {
      currentAppCode = code;
      localStorage.setItem('vibecoding_currentAppCode', code);
      appIframe.srcdoc = code;
    };

    /**
     * Updates the status indicator
     * @param {string} status - 'waiting', 'generating', 'success', 'error'
     * @param {string} message - The message to display
     */
    function updateStatus(status, message) {
      generationStatus.className = `status-indicator ${status}`;
      generationStatus.textContent = message;
    };

    /**
     * Cancels current generation if running
     */
    function cancelGeneration() {
      if (abortController) {
        abortController.abort();
        abortController = null;
      }
      if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
      }
      isGenerating = false;
    };

    /**
     * Extracts the HTML code from the LLM's response.
     * @param {string} responseText - The full response from the LLM.
     * @returns {string|null} The extracted HTML code or null if not found.
     */
    function extractHtmlCode(responseText) {
      // Try to extract from a fenced code block, tolerant of label/case/whitespace
      const fenceRegex = /```(?:html|HTML)?\s*([\s\S]*?)\s*```/i;
      const match = fenceRegex.exec(responseText);
      if (match && match[1]) {
        return match[1].trim();
      }
      // Fallback: if the whole response looks like an HTML document, use it
      const looksLikeHtml = /^\s*<!DOCTYPE html[\s\S]*<\/html>\s*$/i.test(responseText);
      if (looksLikeHtml) {
        return responseText.trim();
      }
      return null;
    };

    /**
     * Schedules app regeneration after debounce delay
     */
    function scheduleRegeneration() {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      updateStatus('waiting', 'Waiting for input to settle...');

      debounceTimer = setTimeout(() => {
        regenerateApp();
      }, 1000); // 1 second debounce
    };

    /**
     * Simple token estimation function
     * @param {string} text - Text to estimate tokens for
     * @returns {number} Estimated token count
     */
    function estimateTokens(text) {
      // Rough estimation: ~4 characters per token for English text
      return Math.ceil(text.length / 4);
    };

    /**
     * Regenerates the app based on current spec vs previous spec
     */
    async function regenerateApp() {
      if (isGenerating) return;

      const newSpec = appSpec.value.trim();

      // If spec hasn't changed, don't regenerate
      if (newSpec === currentSpec) {
        updateStatus('waiting', 'Ready for input...');
        return;
      }

      // If spec is empty but was previously not empty, reset to initial state
      if (!newSpec && currentSpec) {
        updateIframe(initialAppCode);
        currentSpec = '';
        localStorage.setItem('vibecoding_currentSpec', '');
        updateStatus('waiting', 'Spec cleared - showing initial app');
        return;
      }

      // If spec is empty and was always empty, do nothing
      if (!newSpec) {
        updateStatus('waiting', 'Ready for input...');
        return;
      }

      if (!apiKey) {
        updateStatus('error', 'Please set your OpenRouter API key first.');
        return;
      }

      isGenerating = true;
      abortController = new AbortController();
      updateStatus('generating', 'Generating application...');

      try {
        const startTime = performance.now();

        const systemPrompt = `You are an expert web developer. Your task is to build a web application based on a specification.

You will be given:
1. The previous specification (what the app was supposed to do before)
2. The current specification (what the app should do now)
3. The previous application code (the code that implemented the previous spec)

Your task is to generate the COMPLETE, new code that implements the current specification.
Consider the differences between the previous and current specifications to understand what changes need to be made. Leave everything else the same so only updates in spec are reflected in code.

Use the previous code as a reference, but generate complete new code that fulfills the current specification.

DO NOT provide explanations, comments, or any text outside of the HTML code block.
Your response MUST be a single markdown code block of type 'html'.
The application should use Tailwind CSS for styling and modern plain js for interactive functionality.
Always return the full HTML document, from <!DOCTYPE html> to </html>.`;

        const prompt = `Previous specification:
\`\`\`
${currentSpec || 'No previous specification'}
\`\`\`

Current specification:
\`\`\`
${newSpec}
\`\`\`

Previous application code:
\`\`\`html
${currentAppCode}
\`\`\`

Generate the complete application code that implements the current specification:`;

        const inputTokens = estimateTokens(systemPrompt + prompt);

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
            'HTTP-Referer': window.location.origin,
            'X-Title': 'Vibecoding'
          },
          body: JSON.stringify({
            model: selectedModel,
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: prompt }
            ],
            temperature: 0.2,
            provider: {
              only: ["cerebras"]
            }
          }),
          signal: abortController.signal
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const completion = await response.json();
        const endTime = performance.now();
        const duration = Math.round(endTime - startTime);

        const assistantResponse = completion.choices[0].message.content;
        const outputTokens = estimateTokens(assistantResponse);
        const newHtmlCode = extractHtmlCode(assistantResponse);

        if (newHtmlCode) {
          updateIframe(newHtmlCode);
          currentSpec = newSpec;
          localStorage.setItem('vibecoding_currentSpec', newSpec);
          updateStatus('success', `Generated in ${duration}ms (${inputTokens}→${outputTokens} tokens)`);
        } else {
          updateStatus('error', 'Failed to extract valid HTML from response');
        }

      } catch (error) {
        if (error.name === 'AbortError') {
          updateStatus('waiting', 'Generation cancelled');
        } else {
          console.error('API Error:', error);
          updateStatus('error', `Error: ${error.message}`);
        }
      } finally {
        isGenerating = false;
        abortController = null;
      }
    }

    /**
     * Handles spec input changes with debouncing and cancellation
     */
    function handleSpecInput() {
      // Cancel any ongoing generation
      if (isGenerating) {
        cancelGeneration();
        updateStatus('waiting', 'Generation cancelled - new input detected');
      }

      // Schedule new regeneration
      scheduleRegeneration();
    }

    /**
     * Resets the application to its initial state
     */
    function resetApp() {
      // Cancel any ongoing generation
      if (isGenerating) {
        cancelGeneration();
      }

      // Clear the spec
      appSpec.value = '';
      currentSpec = '';
      localStorage.setItem('vibecoding_currentSpec', '');

      // Reset to initial app code
      updateIframe(initialAppCode);

      // Update status
      updateStatus('waiting', 'Application reset to initial state');
    }

    // --- Event Listeners ---
    apiKeyInput.addEventListener('input', (e) => {
      apiKey = e.target.value;
      localStorage.setItem('vibecoding_apiKey', apiKey);
    });

    modelSelect.addEventListener('change', (e) => {
      selectedModel = e.target.value;
      localStorage.setItem('vibecoding_selectedModel', selectedModel);
    });

    appSpec.addEventListener('input', handleSpecInput);
    appSpec.addEventListener('paste', handleSpecInput);

    resetButton.addEventListener('click', resetApp);

    // --- Initialization ---
    function initialize() {
      apiKeyInput.value = apiKey;
      modelSelect.value = selectedModel;
      appSpec.value = currentSpec;

      // Load saved app code or use initial code
      const savedAppCode = currentAppCode || initialAppCode;
      updateIframe(savedAppCode);

      if (currentSpec) {
        updateStatus('waiting', 'Ready for input...');
      } else {
        updateStatus('waiting', 'Enter your OpenRouter API key above, select your model, then describe your app in the specification area.');
      }
    };

    initialize();

  </script>
</body>

</html>
