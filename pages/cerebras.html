<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibecoding</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --sidebar-bg: #1a1a1a;
            --main-bg: #f0f0f0;
            --text-color: #e0e0e0;
            --input-bg: #2a2a2a;
            --border-color: #333;
            --accent-color: #007bff;
            --user-msg-bg: #2c3e50;
            --assistant-msg-bg: #252525;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: var(--sidebar-bg);
        }

        #app-container {
            display: flex;
            height: 100%;
        }

        #sidebar {
            width: 350px;
            min-width: 300px;
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            box-sizing: border-box;
            border-right: 1px solid var(--border-color);
        }

        #sidebar h1 {
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .api-key-container,
        .model-selector-container {
            margin-bottom: 1rem;
        }

        .api-key-container label,
        .model-selector-container label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 0.25rem;
            display: block;
        }

        #apiKeyInput,
        #modelSelect {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        #modelSelect {
            cursor: pointer;
        }

        #modelSelect option {
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Simple scrollbar styling */
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: var(--input-bg); }
        #chat-messages::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        .message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            background-color: var(--user-msg-bg);
            margin-left: 20px;
        }

        .message.assistant {
            background-color: var(--assistant-msg-bg);
        }

        .message.system {
            background-color: #3d3d3d;
            font-style: italic;
            font-size: 0.9em;
            color: #ccc;
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #999;
        }

        #chat-form {
            display: flex;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        #chat-input {
            flex-grow: 1;
            padding: 0.75rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px 0 0 4px;
            resize: none;
            font-family: inherit;
        }

        #chat-form button {
            padding: 0.75rem 1rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }
        #chat-form button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #main-content {
            flex-grow: 1;
            background-color: var(--main-bg);
        }

        #app-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Styling for code blocks inside messages */
        .message pre {
            background-color: #111;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message code {
            font-family: "Courier New", Courier, monospace;
            font-size: 0.9em;
        }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="sidebar">
            <h1>Vibecoding</h1>
            <div class="api-key-container">
                <label for="apiKeyInput">OpenRouter API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Enter your key here">
            </div>
            <div class="model-selector-container">
                <label for="modelSelect">Model</label>
                <select id="modelSelect">
                    <option value="openai/gpt-oss-120b">OpenAI GPT OSS 120B</option>
                    <option value="qwen/qwen3-235b-a22b-2507">Qwen 3 235B</option>
                    <option value="qwen/qwen3-coder">Qwen 3 Coder</option>
                    <option value="meta-llama/llama-4-maverick">Llama 4 Maverick</option>
                    <option value="meta-llama/llama-4-scout">Llama 4 Scout</option>
                    <option value="meta-llama/llama-3.1-8b-instruct">Llama 3.1 8B</option>
                </select>
            </div>
            <div id="chat-messages"></div>
            <form id="chat-form">
                <textarea id="chat-input" placeholder="Describe the changes you want..." rows="3"></textarea>
                <button type="submit" id="send-button">Send</button>
            </form>
        </div>
        <div id="main-content">
            <iframe id="app-iframe" title="Live Application Preview"></iframe>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelSelect = document.getElementById('modelSelect');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const appIframe = document.getElementById('app-iframe');

        // --- State Management ---
        let apiKey = localStorage.getItem('vibecoding_apiKey') || '';
        let selectedModel = localStorage.getItem('vibecoding_selectedModel') || 'openai/gpt-oss-120b';
        console.log(selectedModel);
        let chatHistory = [];
        let currentAppCode = '';
        let isLoading = false;

        // --- Initial Application Code ---
        const initialAppCode = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibecoding App</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script type="module" src="https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js"><\/script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-screen">
    <div class="text-center p-4">
        <h1 class="text-4xl font-bold text-gray-800 dark:text-white">Welcome to your App!</h1>
        <p class="mt-2 text-lg text-gray-600 dark:text-gray-300">Tell me what you want to build in the chat on the left.</p>
    </div>
</body>
</html>`;

        // --- Core Functions ---

        /**
         * Updates the iframe with the provided HTML code.
         * @param {string} code The HTML code to render.
         */
        function updateIframe(code) {
            currentAppCode = code;
            appIframe.srcdoc = code;
        }

        /**
         * Adds a message to the chat UI.
         * @param {string} role - 'user', 'assistant', or 'system'.
         * @param {string} content - The message content.
         */
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);

            let roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);

            // Use marked.js to render markdown, especially for code blocks
            const renderedContent = marked.parse(`<strong>${roleDisplay}</strong>${content}`);
            messageDiv.innerHTML = renderedContent;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Extracts the HTML code from the LLM's response.
         * @param {string} responseText - The full response from the LLM.
         * @returns {string|null} The extracted HTML code or null if not found.
         */
        function extractHtmlCode(responseText) {
            const match = /```html\n([\s\S]*?)\n```/.exec(responseText);
            return match ? match[1] : null;
        }

        /**
         * Toggles the loading state of the UI.
         */
        function setLoading(loading) {
            isLoading = loading;
            chatInput.disabled = loading;
            sendButton.disabled = loading;
            sendButton.textContent = loading ? '...' : 'Send';
        }

        /**
         * Simple token estimation function
         * @param {string} text - Text to estimate tokens for
         * @returns {number} Estimated token count
         */
        function estimateTokens(text) {
            // Rough estimation: ~4 characters per token for English text
            return Math.ceil(text.length / 4);
        }

        /**
         * Marks the last user message as completed with a checkmark and stats.
         * @param {number} duration - API call duration in milliseconds
         * @param {number} inputTokens - Estimated input tokens
         * @param {number} outputTokens - Estimated output tokens
         */
        function markUserMessageCompleted(duration = 0, inputTokens = 0, outputTokens = 0) {
            const userMessages = chatMessages.querySelectorAll('.message.user');
            if (userMessages.length > 0) {
                const lastUserMessage = userMessages[userMessages.length - 1];
                if (!lastUserMessage.querySelector('.completion-check')) {
                    const statsContainer = document.createElement('div');
                    statsContainer.classList.add('completion-check');
                    statsContainer.style.color = '#4CAF50';
                    statsContainer.style.fontWeight = 'bold';
                    statsContainer.style.fontSize = '0.7rem';
                    statsContainer.style.marginTop = '8px';
                    statsContainer.style.display = 'flex';
                    statsContainer.style.alignItems = 'center';
                    statsContainer.style.gap = '8px';

                    const checkmark = document.createElement('span');
                    checkmark.innerHTML = '✓';
                    checkmark.style.fontSize = '1rem';

                    const stats = document.createElement('span');
                    stats.style.color = '#888';
                    stats.innerHTML = `${duration}ms | ${inputTokens}→${outputTokens} tokens`;

                    statsContainer.appendChild(checkmark);
                    statsContainer.appendChild(stats);
                    lastUserMessage.appendChild(statsContainer);
                }
            }
        }

        /**
         * Handles the chat form submission.
         * @param {Event} event - The form submission event.
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            if (isLoading) return;

            const userInput = chatInput.value.trim();
            if (!userInput) return;

            if (!apiKey) {
                addMessageToChat('system', 'Error: Please set your OpenRouter API key first.');
                return;
            }

            setLoading(true);
            addMessageToChat('user', userInput);
            chatHistory.push({ role: 'user', content: userInput });
            chatInput.value = '';

            try {
                // Start timer
                const startTime = performance.now();

                const systemPrompt = `You are an expert web developer. Your task is to build a web application based on user requests.
You will be given the user's request and the current full HTML code of the application.
You must return the COMPLETE, new HTML code for the application that incorporates the user's request.
DO NOT provide explanations, comments, or any text outside of the HTML code block.
Your response MUST be a single markdown code block of type 'html'.
The application should use Tailwind CSS for styling and Lit for interactive web components, both of which are already included via CDN in the initial code.
Always return the full HTML document, from <!DOCTYPE html> to </html>.`;

                const messagesForApi = [
                    { role: 'system', content: systemPrompt },
                    ...chatHistory,
                    {
                        role: 'user',
                        // **FIXED HERE**: Escaped the backticks for the markdown code fence
                        content: `Here is my request: "${userInput}".\n\nHere is the current application code:\n\`\`\`html\n${currentAppCode}\n\`\`\``
                    }
                ];

                // Calculate input tokens
                const inputText = messagesForApi.map(msg => msg.content).join('');
                const inputTokens = estimateTokens(inputText);

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Vibecoding'
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: messagesForApi,
                        temperature: 0.2,
                        provider: { only: ["Cerebras"] }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const completion = await response.json();

                // Calculate duration and output tokens
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                const assistantResponse = completion.choices[0].message.content;
                const outputTokens = estimateTokens(assistantResponse);
                const newHtmlCode = extractHtmlCode(assistantResponse);

                if (newHtmlCode) {
                    updateIframe(newHtmlCode);
                    // Don't add to chat history or display the code
                    // Just mark the user message as completed with stats
                    markUserMessageCompleted(duration, inputTokens, outputTokens);
                } else {
                    addMessageToChat('system', `Error: The model did not return valid HTML code. Here is the raw response:\n\n${assistantResponse}`);
                    // Don't add the failed response to history to allow for a retry
                }

            } catch (error) {
                console.error('API Error:', error);
                addMessageToChat('system', `An API error occurred: ${error.message}`);
            } finally {
                setLoading(false);
                chatInput.focus();
            }
        }

        // --- Event Listeners ---
        apiKeyInput.addEventListener('input', (e) => {
            apiKey = e.target.value;
            localStorage.setItem('vibecoding_apiKey', apiKey);
        });

        modelSelect.addEventListener('change', (e) => {
            selectedModel = e.target.value;
            localStorage.setItem('vibecoding_selectedModel', selectedModel);
        });

        chatForm.addEventListener('submit', handleFormSubmit);

        // Allow Shift+Enter for new lines, Enter to submit
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleFormSubmit(e);
            }
        });

        // --- Initialization ---
        function initialize() {
            apiKeyInput.value = apiKey;
            modelSelect.value = selectedModel;
            updateIframe(initialAppCode);
            addMessageToChat('system', 'Welcome to Vibecoding! Enter your OpenRouter API key above, select your preferred model, then describe what you want to build.');
        }

        initialize();

    </script>
</body>
</html>
